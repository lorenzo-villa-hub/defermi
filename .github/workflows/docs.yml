name: Build Documentation

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx myst-parser nbsphinx sphinx-autodoc-typehints
          pip install .

      - name: Prepare docs folder (if missing)
        run: |
          mkdir -p docs
          if [ ! -f docs/conf.py ]; then
            sphinx-quickstart docs --project "defy" --author "Lorenzo Villa" --release "0.1.0" --quiet --ext-autodoc --ext-viewcode --ext-napoleon
          fi

      - name: Generate API documentation
        run: |
          sphinx-apidoc -o docs ./defy "./defy/**/tests*" "./defy/**/testing*"

      - name: Patch conf.py
        run: |
          echo "
import os, sys
sys.path.insert(0, os.path.abspath('../defy'))
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.napoleon',
    'sphinx.ext.viewcode',
    'myst_parser',
    'nbsphinx',
    'sphinx_autodoc_typehints',
]
exclude_patterns = ['_build', 'Thumbs.db', '.DS_Store', '**/tests/**', '**/testing/**']
" > docs/conf.py

      - name: Build HTML docs
        run: |
          sphinx-build -b html docs docs/_build/html -v

      - name: Upload HTML as artifact
        uses: actions/upload-artifact@v4
        with:
          name: html-docs
          path: docs/_build/html
